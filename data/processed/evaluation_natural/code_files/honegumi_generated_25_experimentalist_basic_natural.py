# Generated by Honegumi (https://arxiv.org/abs/2502.06815)
# %pip install ax-platform==0.4.3 matplotlib
import numpy as np
import pandas as pd
from ax.service.ax_client import AxClient, ObjectiveProperties
import matplotlib.pyplot as plt


# Set random seed for reproducible simulated measurements (remove/change for real experiments)
rng = np.random.default_rng(2025)

objective_metric_name = "biomass_yield_g_per_l"


def evaluate_fermentation_medium(
    glucose_g_per_l: float,
    nitrogen_source_g_per_l: float,
    phosphate_g_per_l: float,
) -> float:
    """
    Simulated evaluation of biomass yield (g/L) for a fermentation culture, given
    medium concentrations of glucose (carbon source), nitrogen source, and phosphate.

    This function models:
    - Saturation kinetics (diminishing returns) for each nutrient
    - Stoichiometric balance penalty (C:N:P balance requirement)
    - High-concentration toxicity/osmotic stress penalties
    - Experimental noise

    Replace this function with the actual laboratory or bioreactor readout:
      Example real-world procedure:
        1. Prepare medium at specified concentrations.
        2. Inoculate and incubate culture under standard conditions.
        3. Measure biomass (e.g., OD600 converted to dry cell weight, or dry weight directly).
        4. Return the biomass concentration in g/L.

    Parameters
    ----------
    glucose_g_per_l : float
        Glucose concentration in g/L (typical useful range ~0–60 g/L).
    nitrogen_source_g_per_l : float
        Nitrogen source concentration in g/L (e.g., ammonium sulfate or yeast extract; range ~0–15 g/L).
    phosphate_g_per_l : float
        Phosphate concentration in g/L (e.g., KH2PO4/K2HPO4; range ~0–5 g/L).

    Returns
    -------
    float
        Simulated biomass yield in g/L.
    """

    g = max(0.0, float(glucose_g_per_l))
    n = max(0.0, float(nitrogen_source_g_per_l))
    p = max(0.0, float(phosphate_g_per_l))

    # Saturation kinetics (Monod-like)
    K_g, K_n, K_p = 15.0, 3.0, 0.5  # half-saturation constants (g/L)
    saturation = (g / (K_g + g)) * (n / (K_n + n)) * (p / (K_p + p))

    # Balance penalty based on target mass ratio (g/L): glucose:nitrogen:phosphate ≈ 20:4:1
    # Penalize deviation from this ratio using coefficient of variation of normalized components
    target = np.array([20.0, 4.0, 1.0])
    vec = np.array([g, n, p]) / target
    mean_vec = np.mean(vec) + 1e-9
    cv = np.std(vec) / mean_vec  # 0 (perfect balance) to higher values (imbalance)
    balance_penalty = float(np.exp(-2.0 * cv))  # in (0, 1]

    # Toxicity/osmotic-stress penalties for excessive concentrations
    tox_thr_g, tox_thr_n, tox_thr_p = 40.0, 10.0, 3.0  # threshold (g/L)
    tox_decay_g, tox_decay_n, tox_decay_p = 10.0, 3.0, 1.0  # decay scales (g/L)
    penalty_g = float(np.exp(-max(0.0, g - tox_thr_g) / tox_decay_g))
    penalty_n = float(np.exp(-max(0.0, n - tox_thr_n) / tox_decay_n))
    penalty_p = float(np.exp(-max(0.0, p - tox_thr_p) / tox_decay_p))
    toxicity_penalty = penalty_g * penalty_n * penalty_p  # in (0, 1]

    # Base scale for achievable biomass (g/L) under ideal balance and no toxicity
    base_max_yield = 15.0  # typical upper bound for many lab strains in batch mode

    # Deterministic yield (noiseless)
    deterministic_yield = base_max_yield * saturation * balance_penalty * toxicity_penalty

    # Add experimental noise: multiplicative (log-normal) + small additive Gaussian
    multiplicative_noise = rng.lognormal(mean=0.0, sigma=0.05)  # ~5% CV
    additive_noise = rng.normal(loc=0.0, scale=0.15)  # small absolute noise in g/L

    measured_yield = deterministic_yield * multiplicative_noise + additive_noise

    return float(max(0.0, measured_yield))


ax_client = AxClient()

# Define the search space for medium optimization
ax_client.create_experiment(
    parameters=[
        {
            "name": "glucose_g_per_l",
            "type": "range",
            "bounds": [0.0, 60.0],
            "value_type": "float",
        },
        {
            "name": "nitrogen_source_g_per_l",
            "type": "range",
            "bounds": [0.0, 15.0],
            "value_type": "float",
        },
        {
            "name": "phosphate_g_per_l",
            "type": "range",
            "bounds": [0.0, 5.0],
            "value_type": "float",
        },
    ],
    objectives={
        objective_metric_name: ObjectiveProperties(minimize=False),
    },
    # By default Ax assumes noisy observations; no explicit noise model needed here.
)

# Run up to the allocated budget of 30 cultures (sequential evaluations)
num_trials = 30
for i in range(num_trials):
    parameterization, trial_index = ax_client.get_next_trial()

    # Extract parameters for the wet-lab (or simulated) run
    glucose = parameterization["glucose_g_per_l"]
    nitrogen = parameterization["nitrogen_source_g_per_l"]
    phosphate = parameterization["phosphate_g_per_l"]

    # Evaluate (replace with actual measurement in production)
    biomass_yield = evaluate_fermentation_medium(glucose, nitrogen, phosphate)

    # Report result back to Ax
    ax_client.complete_trial(
        trial_index=trial_index,
        raw_data={objective_metric_name: biomass_yield},
    )

best_parameters, best_metrics = ax_client.get_best_parameters()

# Print best found medium composition and corresponding yield estimate
print("Best medium parameters found:")
for k, v in best_parameters.items():
    print(f"  {k}: {v:.4f}")
print("Best observed metrics:")
for m, val in best_metrics.items():
    try:
        mean_val = float(val[0])
    except Exception:
        mean_val = float(val)
    print(f"  {m}: {mean_val:.4f}")

# Plot results
obj_name = ax_client.objective_names[0]
df = ax_client.get_trials_data_frame()

fig, ax = plt.subplots(figsize=(6, 4), dpi=150)
y_obs = pd.to_numeric(df[obj_name], errors="coerce")

ax.scatter(df.index, y_obs, ec="k", fc="none", label="Observed")

# Best-so-far (cumulative maximum)
y_vals = y_obs.fillna(-np.inf).values
best_so_far = np.maximum.accumulate(y_vals)
best_so_far[best_so_far == -np.inf] = np.nan
ax.plot(df.index, best_so_far, color="#0033FF", lw=2, label="Best to Trial")

ax.set_xlabel("Trial Number")
ax.set_ylabel(f"{obj_name.replace('_', ' ')}")
ax.set_title("Fermentation Medium Optimization: Biomass Yield")
ax.legend()
plt.tight_layout()
plt.show()