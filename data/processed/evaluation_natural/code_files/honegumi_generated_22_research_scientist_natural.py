# Generated by Honegumi (https://arxiv.org/abs/2502.06815)
# %pip install ax-platform==0.4.3 matplotlib
import numpy as np
import pandas as pd
from ax.service.ax_client import AxClient, ObjectiveProperties
import matplotlib.pyplot as plt


# Domain: Spray coating process optimization for film thickness uniformity
# Parameters:
#   - spray_distance_mm: nozzle-to-substrate distance [100, 300] mm
#   - atomizing_air_pressure_bar: atomizing air pressure [0.5, 3.0] bar
# Objective:
#   - thickness_nonuniformity: coefficient of variation (std/mean) of the simulated deposited film thickness across the panel (dimensionless), to be minimized

metric_name = "thickness_nonuniformity"

# Reproducible RNG for simulated measurement noise
rng = np.random.default_rng(2025)


def evaluate_coating_uniformity(spray_distance_mm: float, atomizing_air_pressure_bar: float) -> dict:
    """
    Physics-inspired simulation of coating thickness distribution over a flat panel
    for a raster spray process, returning thickness non-uniformity (lower is better).

    This function models the spray plume as a Gaussian footprint whose width (sigma)
    increases with nozzle distance and atomizing air pressure. The panel is coated by
    multiple parallel passes with fixed spacing. Uniformity is computed as the
    coefficient of variation over the panel width after summing contributions from all passes.

    Parameters
    ----------
    spray_distance_mm : float
        Nozzle-to-substrate standoff distance in millimeters.
    atomizing_air_pressure_bar : float
        Atomizing air pressure in bar.

    Returns
    -------
    dict
        {"thickness_nonuniformity": float}
    """
    # Panel and process constants (can be adjusted to match the real setup)
    panel_width_mm = 280.0          # width of the coated panel
    pass_pitch_mm = 40.0            # center-to-center spacing between adjacent passes
    # Model the spray plume width (1D Gaussian sigma across the pass)
    # Wider plume with larger distance and higher pressure (plausible trend)
    sigma_mm = 0.16 * float(spray_distance_mm) + 6.0 * float(atomizing_air_pressure_bar)
    sigma_mm = float(np.clip(sigma_mm, 5.0, 120.0))  # bound for numerical stability

    # 1D discretization across panel width
    x = np.linspace(-panel_width_mm / 2.0, panel_width_mm / 2.0, 501)

    # Determine pass centers to cover panel plus margins (tails up to ~3 sigma)
    margin = 3.0 * sigma_mm
    start = -panel_width_mm / 2.0 - margin
    end = panel_width_mm / 2.0 + margin
    first_center = np.floor(start / pass_pitch_mm) * pass_pitch_mm
    pass_centers = np.arange(first_center, end + pass_pitch_mm, pass_pitch_mm)

    # Sum Gaussian contributions from all passes (amplitude set to 1.0 for uniformity analysis)
    # T(x) proportional to summed overlap; edges naturally show less overlap
    T = np.zeros_like(x)
    inv_two_sigma2 = 1.0 / (2.0 * sigma_mm * sigma_mm)
    for c in pass_centers:
        T += np.exp(-((x - c) ** 2) * inv_two_sigma2)

    # Compute coefficient of variation (std/mean) across the panel
    mean_T = float(np.mean(T))
    std_T = float(np.std(T))
    cv = std_T / (mean_T + 1e-12)  # guard against division by zero

    # Add small measurement noise to mimic real experimental conditions
    noise_sd = 0.003  # ~0.3% absolute CV noise
    measured_cv = max(0.0, cv + rng.normal(0.0, noise_sd))

    return {metric_name: measured_cv}


ax_client = AxClient()

ax_client.create_experiment(
    parameters=[
        {"name": "spray_distance_mm", "type": "range", "bounds": [100.0, 300.0]},
        {"name": "atomizing_air_pressure_bar", "type": "range", "bounds": [0.5, 3.0]},
    ],
    objectives={
        metric_name: ObjectiveProperties(minimize=True),
    },
)


# Run the planned 25 experiments sequentially (batch size = 1)
num_trials = 25
for i in range(num_trials):
    parameterization, trial_index = ax_client.get_next_trial()

    # Extract parameters for this trial
    spray_distance_mm = parameterization["spray_distance_mm"]
    atomizing_air_pressure_bar = parameterization["atomizing_air_pressure_bar"]

    # Evaluate the process (simulation stub; replace with real measurement if available)
    results = evaluate_coating_uniformity(spray_distance_mm, atomizing_air_pressure_bar)

    # Report results back to Ax
    ax_client.complete_trial(trial_index=trial_index, raw_data=results)

best_parameters, metrics = ax_client.get_best_parameters()
print("Best parameters found:")
print(best_parameters)
print("Observed objective at best parameters:")
print(metrics)


# Plot results
objectives = ax_client.objective_names
df = ax_client.get_trials_data_frame()

fig, ax = plt.subplots(figsize=(6, 4), dpi=150)
ax.scatter(df.index, df[objectives], ec="k", fc="none", label="Observed")
ax.plot(
    df.index,
    np.minimum.accumulate(df[objectives]),
    color="#0033FF",
    lw=2,
    label="Best to Trial",
)
ax.set_xlabel("Trial Number")
ax.set_ylabel(objectives[0])

ax.legend()
plt.show()